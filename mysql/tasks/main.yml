---

- name: Install mysql
  apt: name={{ item }} state=present
  with_items:
    - mysql-server
    - mysql-client
    - libmysqlclient-dev
    - python-mysqldb

- name: Start mysql service
  service: name=mysql state=restarted

- name: Create mysql databases
  mysql_db: name={{ item.name }} state=present
  with_items: mysql.databases
  when: mysql is defined and mysql.databases is defined

- name: Create mysql users
  mysql_user: >
    name={{ item.name }}
    password={{ item.password|default(item.name)}}
    host={{ item.host|default('%')}}
    priv={{ item.priv|default('*.*:ALL') }}
    state=present
  with_items: mysql.users
  when: mysql is defined and mysql.users is defined

- name: Configure mysql server
  template: src=my.cnf.j2 dest=/etc/mysql/my.cnf
  notify:
    - Restart mysql
